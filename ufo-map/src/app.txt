import {
  ArcElement,
  BarElement,
  CategoryScale,
  Chart as ChartJS,
  Legend,
  LinearScale,
  LineElement,
  PointElement,
  Title,
  Tooltip,
} from "chart.js";
import "leaflet/dist/leaflet.css";
import Papa from "papaparse";
import { useEffect, useMemo, useState } from "react";
import { Bar, Line, Pie } from "react-chartjs-2";
import { CircleMarker, MapContainer, Popup, TileLayer } from "react-leaflet";
import "./App.css";

ChartJS.register(
  CategoryScale,
  LinearScale,
  BarElement,
  PointElement,
  LineElement,
  Title,
  Tooltip,
  Legend,
  ArcElement
);

const continentMap = {
  AF: "Africa",
  AN: "Antarctica",
  AS: "Asia",
  EU: "Europe",
  NA: "North America",
  OC: "Oceania",
  SA: "South America",
};

function App() {
  const [data, setData] = useState([]);
  const [selectedContinent, setSelectedContinent] = useState(null);
  const [selectedCountry, setSelectedCountry] = useState(null);
  const [selectedRecord, setSelectedRecord] = useState(null);

  useEffect(() => {
    Papa.parse("/UFO_dataset.csv", {
      download: true,
      header: true,
      skipEmptyLines: true,
      transformHeader: (header) =>
        header.replace(/[^a-zA-Z0-9]/g, "").toLowerCase(),
      complete: (results) => {
        const countryToContinent = {
          AU: "Oceania",
          CA: "North America",
          DE: "Europe",
          GB: "Europe",
          US: "North America",
        };

        const validData = results.data
          .filter((item) => item.latitude && item.longitude)
          .slice(0, 8000)
          .map((item) => {
            const code = item.country?.toUpperCase();
            const continent = countryToContinent[code] || "Unknown";
            return {
              ...item,
              country: code || "Unknown",
              continent: continent,
            };
          });

        setData(validData);
      },
    });
  }, []);

  const filteredData = useMemo(() => {
    if (selectedCountry)
      return data.filter((d) => d.country === selectedCountry);
    if (selectedContinent)
      return data.filter((d) => d.continent === selectedContinent);
    return data.slice(0, 100);
  }, [data, selectedContinent, selectedCountry]);

  // Prepare chart data when continent is selected
  const continentData = data.filter((d) => d.continent === selectedContinent);
  const countriesList = [...new Set(continentData.map((d) => d.country))];
  const countryCounts = countriesList.map(
    (country) => continentData.filter((d) => d.country === country).length
  );

  const yearCounts = {};
  continentData.forEach((d) => {
    const year = d.datetime?.split(" ")[0].split("/")[2];
    if (year) yearCounts[year] = (yearCounts[year] || 0) + 1;
  });
  const years = Object.keys(yearCounts).sort((a, b) => a - b);
  const counts = years.map((year) => yearCounts[year]);

  const shapes = [...new Set(continentData.map((d) => d.shape))];
  const shapeCounts = shapes.map(
    (shape) => continentData.filter((d) => d.shape === shape).length
  );

  return (
    <div className="app-container">
      {/* Floating Sidebar */}
      <div className="sidebar">
        {!selectedContinent && (
          <>
            <h3>Select a Continent</h3>
            {[...new Set(data.map((d) => d.continent))].map((continent) => (
              <button
                key={continent}
                onClick={() => {
                  setSelectedContinent(continent);
                  setSelectedCountry(null);
                  setSelectedRecord(null);
                }}
              >
                {continent}
              </button>
            ))}
          </>
        )}

        {selectedContinent && !selectedCountry && (
          <>
            <h3>{selectedContinent} - Countries</h3>
            <button onClick={() => setSelectedContinent(null)}>← Back</button>
            {[...new Set(continentData.map((d) => d.country))].map(
              (country) => (
                <button
                  key={country}
                  onClick={() => {
                    setSelectedCountry(country);
                    setSelectedRecord(null);
                  }}
                >
                  {country}
                </button>
              )
            )}

            {/* Charts */}
            <div className="charts">
              <h4>Charts for {selectedContinent}</h4>
              <Bar
                data={{
                  labels: countriesList,
                  datasets: [
                    {
                      label: "Sightings",
                      data: countryCounts,
                      backgroundColor: "#42a5f5",
                    },
                  ],
                }}
                options={{ responsive: true }}
              />
              <Line
                data={{
                  labels: years,
                  datasets: [
                    {
                      label: "Sightings per Year",
                      data: counts,
                      borderColor: "#66bb6a",
                      tension: 0.3,
                    },
                  ],
                }}
                options={{
                  responsive: true,
                  scales: {
                    x: { title: { display: true, text: "Year" } },
                    y: {
                      title: { display: true, text: "Number of Sightings" },
                    },
                  },
                }}
              />
              <Pie
                data={{
                  labels: shapes,
                  datasets: [
                    {
                      data: shapeCounts,
                      backgroundColor: [
                        "#ef5350",
                        "#ab47bc",
                        "#42a5f5",
                        "#26a69a",
                        "#ffca28",
                      ],
                    },
                  ],
                }}
                options={{ responsive: true }}
              />
            </div>
          </>
        )}

        {selectedCountry && (
          <>
            <h3>{selectedCountry} - Records</h3>
            <button onClick={() => setSelectedCountry(null)}>← Back</button>
            {data
              .filter((d) => d.country === selectedCountry)
              .map((item, index) => (
                <div
                  key={index}
                  onClick={() => setSelectedRecord(item)}
                  className="record-item"
                >
                  <strong>{item.datetime}</strong>
                  <br />
                  {item.city}
                </div>
              ))}
          </>
        )}

        {selectedRecord && (
          <div className="record-details">
            <h4>Record Details</h4>
            <p>
              <strong>Date/Time:</strong> {selectedRecord.datetime}
            </p>
            <p>
              <strong>City:</strong> {selectedRecord.city}
            </p>
            <p>
              <strong>Shape:</strong> {selectedRecord.shape}
            </p>
            <p>
              <strong>Duration:</strong> {selectedRecord.durationseconds}{" "}
              seconds
            </p>
            <p>
              <strong>Comments:</strong> {selectedRecord.comments}
            </p>
          </div>
        )}
      </div>

      {/* Map */}
      <MapContainer center={[38, -97]} zoom={4} className="map-container">
        <TileLayer
          attribution="&copy; OpenStreetMap"
          url="https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png"
        />
        {filteredData.map((item, index) => {
          const lat = parseFloat(item.latitude);
          const lng = parseFloat(item.longitude);
          if (isNaN(lat) || isNaN(lng)) return null;
          return (
            <CircleMarker
              key={index}
              center={[lat, lng]}
              radius={5}
              pathOptions={{
                color: "#d64541",
                fillColor: "#d64541",
                fillOpacity: 0.8,
                stroke: false,
              }}
              eventHandlers={{
                click: () => setSelectedRecord(item),
              }}
            >
              <Popup>
                <strong>{item.city}</strong>
                <br />
                {item.shape}
                <br />
                {item.datetime}
              </Popup>
            </CircleMarker>
          );
        })}
      </MapContainer>
    </div>
  );
}

export default App;
